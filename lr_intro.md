## 逻辑回归

### 1. 前言

本节是斯坦福大学机器学习课程前四节加上配套的讲义后的总结与认识。回归问题属于有监督学习中的一种方法。该方法的核心思想是从连续型统计数据中得到数学模型，然后将该数学模型用于预测或者分类。该方法处理的数据可以是多维的。

讲义最初介绍了一个基本问题，然后引出了线性回归的解决方法，然后针对误差问题做了概率解释。之后介绍了logistic回归。最后上升到理论层次，提出了一般回归。

### 2. 问题引入

假设有一个房屋销售的数据如下：

| 面积\($$m^2$$\) | 销售价钱（万元） |
| --- | --- |
| 123 | 250 |
| 150 | 320 |
| 87 | 160 |
| 102 | 220 |
| ... | ... |

这个表类似于北京5环左右的房屋价钱，我们可以做出一个图，x轴是房屋的面积。y轴是房屋的售价，如下：

![Alt text](./1524786401102.png)

如果来了一个新的房屋，假设在销售价钱的记录中没有的，我们怎么办呢？

我们可以用一条曲线去尽量准的拟合这些数据，然后如果有新的输入过来，我们可以在将曲线上这个点对应的值返回。如果用一条直线去拟合，可能是下面的样子：

![Alt text](./1524786420707.png)

绿色的点就是我们想要预测的点。

首先给出一些概念和常用的符号。

**房屋销售记录表：**训练集\(training set\)或者训练数据\(training data\), 是我们流程中的输入数据，一般称为x

**房屋销售价钱：**输出数据，一般称为y

**拟合的函数（或者称为假设或者模型）：**一般写做$$y=h(x)$$

**训练数据的条目数\(\#training set\)：**一条训练数据是由一对输入数据和输出数据组成的输入数据的维度n \(特征的个数，\#features\)

这个例子的特征是两维的，结果是一维的。然而回归方法能够解决特征多维，结果是一维多离散值或一维连续值的问题。

### 3. 学习过程

下面是一个典型的机器学习的过程，首先给出一个输入数据，我们的算法会通过一系列的过程得到一个估计的函数，这个函数有能力对没有见过的新数据给出一个新的估计，也被称为构建一个模型。就如同上面的线性回归函数。

![Alt text](./1524786440698.png)


### 4. 线性回归

线性回归假设特征和结果满足线性关系。其实线性关系的表达能力非常强大，每个特征对结果的影响强弱可以由前面的参数体现，而且每个特征变量可以首先映射到一个函数，然后再参与线性计算。这样就可以表达特征与结果之间的非线性关系。

我们用$X_1,X_2,...X_n$去描述feature里面的分量，比如$x_1=房间的面积$，$x_2=房间的朝向$，等等，我们可以做出一个估计函数：


$$
h(x)=h_\theta(x)=\theta_0 + \theta_1x_1 + \theta_2x_2
$$


在这，$\theta$称为参数，在这的意思是调整feature中每个分量的影响力，就是到底是房屋的面积更重要还是房屋的地段更重要。为了如果我们令$x_0=1$，就可以用向量的方式来表示了:


$$
h_\theta(x)=\theta^TX
$$


我们程序也需要一个机制去评估我们$\theta$是否比较好，所以说需要对我们做出的h函数进行评估，一般这个函数称为损失函数（loss function）或者错误函数(error function)，描述h函数不好的程度，在下面，我们称这个函数为J函数

在这儿我们可以认为错误函数如下：


$$
J(\theta)=\frac{1}{2}\sum_{i=1}^m(h_\theta(x^{(i)})-y^{(i)})^2
$$


其中上标$(i)$表示样本id，这个错误估计函数是去对$x^{(i)}$的估计值与真实值$y^{(i)}$差的平方和作为错误估计函数，前面乘上的1/2是为了在求导的时候，这个系数就不见了。

至于为何选择平方和作为错误估计函数，讲义后面从概率分布的角度讲解了该公式的来源。

如何调整$\theta$以使得$J(\theta)$取得最小值有很多方法，其中有最小二乘法`(min square)`，是一种完全是数学描述的方法，和梯度下降法。

### 5. 梯度下降法

在选定线性回归模型后，只需要确定参数$\theta$，就可以将模型用来预测。然而$\theta$需要在$J(\theta)$最小的情况下才能确定。因此问题归结为求极小值问题，使用梯度下降法。梯度下降法最大的问题是求得有可能是全局极小值，这与初始点的选取有关。

梯度下降法是按下面的流程进行的：

1. 首先对$\theta$赋值，这个值可以是随机的，也可以让$\theta$是一个全零的向量。
2. 改变$\theta$的值，使得$J(\theta)$按梯度下降的方向进行减少。

梯度方向由$J(\theta)$对$\theta$的偏导数确定，由于求的是极小值，因此梯度方向是偏导数的反方向。结果为


$$
\theta_j:=\theta_j+\alpha(y^{(i)}-h_\theta(x^{(i)}))x_j^{(i)}
$$


迭代更新的方式有两种，一种是批梯度下降，也就是对全部的训练数据求得误差后再对$\theta$进行更新，另外一种是增量梯度下降，每扫描一步都要对$\theta$进行更新。前一种方法能够不断收敛，后一种方法结果可能不断在收敛处徘徊。

一般来说，梯度下降法收敛速度还是比较慢的。

另一种直接计算结果的方法是最小二乘法。

### 6. 最小二乘法

将训练特征表示为$X$矩阵，结果表示成$y$向量，仍然是线性回归模型，误差函数不变。那么$\theta$可以直接由下面公式得出


$$
\theta=(X^TX)^{-1}X^T\hat{y}
$$


但此方法要求$X$是列满秩的，而且求矩阵的逆比较慢。

### 7. 选用误差函数为平方和的概率解释

假设根据特征的预测结果与实际结果有误差$\epsilon^{(i)}$，那么预测结果$\theta^Tx^{(i)}$和真实结果$y^{(i)}$满足下式：


$$
y^{(i)}=\theta^Tx^{(i)}+\epsilon^{(i)}
$$


一般来讲，误差满足平均值为$\theta$的高斯分布，也就是正态分布。那么x和y的条件概率也就是


$$
p(y^{(i)}|x^{(i)};\theta)=\frac{1}{\sqrt{2\pi}\sigma}exp(-\frac{(y^{(i)}-\theta^Tx^{(i)})^2}{2\sigma^2})
$$


这样就估计了一条样本的结果概率，然而我们期待的是模型能够在全部样本上预测最准，也就是概率积最大。注意这里的概率积是概率密度函数积，连续函数的概率密度函数与离散值的概率函数不同。这个概率积成为最大似然估计。我们希望在最大似然估计得到最大值时确定$\theta$。那么需要对最大似然估计公式求导，求导结果既是


$$
\frac{1}{2}\sum^{m}_{i=1}(y^{(i)}-\theta^Tx^{(i)})^2
$$


这就解释了为何误差函数要使用平方和。

当然推导过程中也做了一些假定，但这个假定符合客观规律。

### 8. 带权重的线性回归

上面提到的线性回归的误差函数里系统都是1，没有权重。带权重的线性回归加入了权重信息。

基本假设是

1. Fit $\theta$ to minimize $\sum_iw^{(i)}(y^{(i)}-\theta^Tx^{(i)})^2$
2. Output $\theta^Tx$

其中假设$w^{(i)}$符合公式


$$
w^{(i)}=exp(-\frac{(x^{(i)}-x)^2}{2\tau^2})
$$


其中$x$是要预测的特征，这样假设的道理是离$x$越近的样本权重越大，越远的影响越小。这个公式与高斯分布类似，但不一样，因为$w^{(i)}$不是随机变量。

此方法成为非参数学习算法，因为误差函数随着预测值的不同而不同，这样$\theta$无法事先确定，预测一次需要临时计算，感觉类似$KNN$。

### 9. 分类和logistic回归

一般来说，回归不用在分类问题上，因为回归是连续型模型，而且受噪声影响比较大。如果非要应用进入，可以使用logistic回归。

logistic回归本质上是线性回归，只是在特征到结果的映射中加入了一层函数映射，即先把特征线性求和，然后使用函数$g(z)$将最为假设函数来预测。$g(z)$可以将连续值映射到0和1上。

logistic回归的假设函数如下，线性回归假设函数只是$\theta^Tx$。


$$
h_\theta(x)=g(\theta^Tx)=\frac{1}{1+e^{-\theta^Tx}}
$$
$$
g(z)=\frac{1}{1+e^{-z}}
$$


logistic回归用来分类0/1问题，也就是预测结果属于0或者1的二值分类问题。这里假设了二值满足伯努利分布，也就是


$$
P(y=1|x;\theta)=h_\theta(x),
P(y=0|x;\theta)=1-h_\theta(x)
$$


当然假设它满足泊松分布、指数分布等等也可以，只是比较复杂，后面会提到线性回归的一般形式。

与第7节一样，仍然求的是最大似然估计，然后求导，得到迭代公式结果为


$$
\theta_j:=\theta_j+\alpha(y^{(i)}-h_\theta(x^{(i)}))x_j^{(i)}
$$


可以看到与线性回归类似，只是$\theta^Tx^{(i)}$换成了$h_\theta(x^{(i)})$，而$h_\theta(x^{(i)})$实际上就是$\theta^Tx^{(i)}$经过$g(z)$映射过来的。

### 10.牛顿法来解最大似然估计

第7和第9节使用的解最大似然估计的方法都是求导迭代的方法，这里介绍了牛顿下降法，使结果能够快速的收敛。

当要求解$f(\theta)=0$时，如果$f$可导，那么可以通过迭代公式


$$
\theta:=\theta-\frac{f(\theta)}{f'(\theta)}
$$


来迭代求解最小值。

当应用于求解最大似然估计的最大值时，变成求解最大似然估计概率导数$l'(\theta)=0$的问题。  
那么迭代公式写作


$$
\theta:=\theta-\frac{l'(\theta)}{l''(\theta)}
$$


当$\theta$是向量时，牛顿法可以使用下面式子表示

$$\theta:=\theta-H^{-1}\nabla_{\theta}l(\theta)$$

其中$H_{ij}=\frac{\partial^2l(\theta)}{\partial\theta_i\partial\theta_j}$是n×n的Hessian矩阵。

牛顿法收敛速度虽然很快，但求Hessian矩阵的逆的时候比较耗费时间。

当初始点$X_0$靠近极小值$X$时，牛顿法的收敛速度是最快的。但是当$X_0$远离极小值时，牛顿法可能不收敛，甚至连下降都保证不了。原因是迭代点$X_{k+1}$不一定是目标函数$f$在牛顿方向上的极小点。

### 11.一般线性模型

之所以在logistic回归时使用


$$
g(z)=\frac{1}{1+e^{-z}}
$$


的公式是由一套理论作支持的。  
这个理论便是一般线性模型。  
首先，如果一个概率分布可以表示成


$$
p(y;\eta)=b(y)exp(\eta^TT(y)-\alpha(\eta))
$$


时，那么这个概率分布可以称作是指数分布。

伯努利分布，高斯分布，泊松分布，贝塔分布，狄特里特分布都属于指数分布。

在logistic回归时采用的是伯努利分布，伯努利分布的概率可以表示成


$$
p(y;\phi)=\phi^y(1-\phi)^{1-y}
=exp(ylog\phi+(1-y)log(1-\phi))
=exp((log(\frac{\phi}{1-\phi})y+log(1-\phi)))
$$


其中

$$\eta=log(\phi/(1-\phi))$$  
得到$$\Phi=\frac{1}{1+e^\eta}$$  
这就解释了logistic回归时为了要用这个函数。

一般线性模型的要点是

1. $y|x;\theta$满足一个以$\eta$为参数的指数分布，那么可以求得$\eta$的表达式。
2. 给定x，我们的目标是要确定$T(y)$，大多数情况下$T(y)=y$，那么我们实际上要确定的是$h(x)$，而$h(x)=E[y|x]$。（在logistic回归中期望值是$\Phi$，因此h是$\Phi$；在线性回归中期望值是$\mu$，而高斯分布中$\eta=\mu$，因此线性回归中$h=\theta^Tx$）。
3. 最后$\eta=\theta^Tx$.

### 12.Softmax回归

最后举了一个利用一般线性模型的例子。

假设预测值y有k种可能，即$y\in{1,2,...,k}$

比如k=3时，可以看作是要将一封未知邮件分为垃圾邮件、个人邮件还是工作邮件这三类。

定义  
$\phi_i=p(y=i;\phi)$$ 
那么$\sum_{i=1}^{k}\phi_i=1$ 
这样  
$p(y=k;\phi)=1-\sum_{i=1}^{k-1}\phi_i$$ 
即式子左边可以有其他的概率表示，因此可以当作是k-1维的问题。

为了表示多项式分布表述成指数分布，我们引入$T(y)$，它是一组$k-1$维的向量，这里的$T(y)$不是y，$T(y=i)$表示$T(y)$的第$i$个分量。


$$
T(1)
\left[
\begin{array}{c}
    1 \\
    0 \\
    0 \\
    ... \\
    0 \\
\end{array}
\right],
T(2)=\left[
\begin{array}{c}
    0 \\
    1 \\
    0 \\
    ... \\
    0 \\
\end{array}
\right],
T(3)=\left[
\begin{array}{c}
    0 \\
    0 \\
    1 \\
    ... \\
    0 \\
\end{array}
\right],...,
T(k-1)=\left[
\begin{array}{c}
    0 \\
    0 \\
    0 \\
    ... \\
    1 \\
\end{array}
\right],
T(k)=\left[
\begin{array}{c}
    0 \\
    0 \\
    0 \\
    ... \\
    0 \\
\end{array}
\right]
$$


应用于一般线性模型，结果y必然是k中的一种。1{y=k}表示第k个值为1，那么p\(y\)可以表示为

$$p(y;\phi)=\phi^{1\{y=1\}}_1\phi^{1\{y=2\}}_2...\phi^{1\{y=k\}}_k$$

$$=\phi^{1\{y=1\}}_1\phi^{1\{y=2\}}_2...\phi^{1-\sum^{k-1}_{i=1}1\{y=k\}}_k$$

$$=\phi^{T(y)_1}_1\phi^{T(y)_1}_2...\phi^{1-\sum^{k-1}_{i=1}T(y)_i}_k$$

$$=exp(T(y)_1log(\phi_1)+T(y)_2log(\phi_2)+...+(1-\sum_{i=1}^{k-1}T(y)_ilog(\phi_k))$$

$$=exp(T(y)_1log(\phi_1/\phi_k)+T(y)_2log(\phi_2/\phi_k)+...+T(y)_{k-1}log(\phi_{k-1}/\phi_k)+log(\phi_k))$$


$$=b(y)exp(\eta^TT(y)-\alpha(\eta))$$

其实很好理解，就是当y是一个值m（m从1到k）的时候，$p(y)=\Phi_m$，然后形式化了一下。
那么
$$
\eta=  
\left[  
\begin{array}{c}  
    log(\phi_1/\phi_k) \  
    log(\phi_2/\phi_k) \  
    ... \  
    log(\phi_{k-1}/\phi_k) \  
\end{array}  
\right], \\  
a(\eta)=-log(\phi_k),\\  
b(y)=1
$$
最后求得

$$\theta_i=\frac{exp^\eta_i}{\sum_{j=1}^{k}e^{\eta_j}}$$


而$y=i$时


$$
p(y=i|x;\theta)=\phi=\frac{e^\eta_i}{\sum_{j=1}^{k}e^{\eta_j}}=\frac{e^{\theta^T_i}x}{\sum_{j=1}^{k}e^{\theta^T_j}x}
$$


求得期望值


$$
h_\theta(x)=E[T(y)|x;\theta]=E \left[
\begin{array}{c}
    1\{y=1\} \\
    2\{y=1\} \\
    ... \\
    k\{y=1\} \\
\end{array}
|x;\theta
\right]
=\left[
\begin{array}{c}
    \phi_1 \\
    \phi_2 \\
    ... \\
    \phi_{k-1} \\
\end{array}
\right]
=\left[
\begin{array}{c}
    \frac{exp(\theta^T_1x)}{\sum^{k}_{j=1}exp(\theta^T_jx)} \\
    \frac{exp(\theta^T_2x)}{\sum^{k}_{j=1}exp(\theta^T_jx)} \\
    ... \\
    \frac{exp(\theta^T_{k-1}x)}{\sum^{k}_{j=1}exp(\theta^T_jx)} \\
\end{array}
\right]
$$


那么就建立了假设函数，最后就获得了最大似然估计


$$
l(\theta)=\sum_{i=1}^{m}logp(y^{(i)}|x^(i);\theta)=\sum_{i=1}^{m}log\prod_{l=1}^{k}(\frac{e^{\theta_l^Tx^{(i)}}}{\sum_{j=1}^{k}e^{\theta_l^Tx^{(i)}}})^{1\{y^{(i)}=l\}}
$$


对该公式可以使用梯度下降或者牛顿法迭代求解。

解决了多值模型建立与预测问题。

